name: Test Installer Script

on:
  pull_request:
    branches: '**'

  workflow_dispatch:

permissions:
  contents: read

jobs:
  test-install:
    strategy:
      matrix:
        # Test on Linux (x64) and macOS (ARM64/x64)
        os: [ubuntu-latest, macos-latest]
    
    runs-on: ${{ matrix.os }}
    
    steps:
      - name: Checkout project
        uses: actions/checkout@v4

      - name: Setup JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'

      - name: Setup Node 20
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Make install script executable
        run: chmod +x scripts/install.sh

      - name: Run install script
        # Using --no-service because CI runners often lack systemd or we don't want background services
        run: ./scripts/install.sh --yes --no-service

      - name: Verify phoenixd binary
        run: |
          export PATH="/usr/local/bin:$PATH"
          echo "Checking phoenixd in PATH..."
          which phoenixd
          phoenixd --version || echo "phoenixd executed (exit code may be non-zero for version flag)"

      - name: Verify Ambrosia Server
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "Checking ambrosia symlink..."
          which ambrosia
          ls -l $(which ambrosia)
          
          echo "Checking server files..."
          if [ ! -f "$HOME/.local/ambrosia/ambrosia.jar" ]; then
            echo "Error: ambrosia.jar not found"
            exit 1
          fi

      - name: Verify Ambrosia Client
        run: |
          export PATH="$HOME/.local/bin:$PATH"
          echo "Checking ambrosia-client symlink..."
          which ambrosia-client
          ls -l $(which ambrosia-client)
          
          echo "Checking client files and dependencies..."
          if [ ! -f "$HOME/.local/ambrosia/run-client.sh" ]; then
            echo "Error: run-client.sh not found"
            exit 1
          fi
          
          # Verify npm install ran (node_modules should exist)
          if [ ! -d "$HOME/.local/ambrosia/client/node_modules" ]; then
            echo "Error: node_modules not found in client directory"
            exit 1
          fi